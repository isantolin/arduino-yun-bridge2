<%+header%>
<h2><%:Credentials & TLS%></h2>
<p><%:Manage shared secrets and TLS material without leaving LuCI.%></p>
<div class="cbi-section">
  <h3><%:Rotate Credentials%></h3>
  <p><%:This regenerates YUNBRIDGE_SERIAL_SECRET and the MQTT password, updates /etc/yunbridge/credentials, and restarts the daemon.%></p>
  <button class="cbi-button cbi-button-apply" onclick="rotateCredentials()"><%:Rotate now%></button>
  <pre id="rotate-output"></pre>
</div>
<div class="cbi-section">
  <h3><%:TLS Material%></h3>
  <p><%:Upload new CA/certificate/key files via SCP or the provided helper:%></p>
  <pre>scp tls_bundle.tar.gz root@&lt;yun&gt;:/tmp/
ssh root@&lt;yun&gt; 'mkdir -p /etc/yunbridge/tls && tar -xzf /tmp/tls_bundle.tar.gz -C /etc/yunbridge/tls && chmod 600 /etc/yunbridge/tls/*'</pre>
  <p><%:Point the daemon to the new paths using the main configuration page or by editing /etc/yunbridge/credentials.%></p>
</div>
<div class="cbi-section">
  <h3><%:Hardware Smoke Test%></h3>
  <p><%:Runs /usr/bin/yunbridge-hw-smoke to verify MQTT round trips and service health.%></p>
  <button class="cbi-button" onclick="runSmoke()"><%:Run smoke test%></button>
  <pre id="smoke-output"></pre>
</div>
<script type="text/javascript">
function rotateCredentials() {
  document.getElementById('rotate-output').textContent = 'Running...';
  fetch('<%=url("admin/services/yunbridge/rotate_credentials")%>', {method: 'POST'})
    .then(r => r.json())
    .then(data => {
      document.getElementById('rotate-output').textContent = data.output || data.message || JSON.stringify(data);
    })
    .catch(err => {
      document.getElementById('rotate-output').textContent = err;
    });
}
function runSmoke() {
  document.getElementById('smoke-output').textContent = 'Running...';
  fetch('<%=url("admin/services/yunbridge/hw_smoke")%>', {method: 'POST'})
    .then(r => r.json())
    .then(data => {
      document.getElementById('smoke-output').textContent = data.output || data.message || JSON.stringify(data);
    })
    .catch(err => {
      document.getElementById('smoke-output').textContent = err;
    });
}
</script>
<%+footer%>
