#!/bin/sh
# Rotate YunBridge shared credentials in-place and restart the daemon.
# Usage: yunbridge-rotate-credentials [/etc/yunbridge/credentials]
set -eu

CRED_FILE=${1:-/etc/yunbridge/credentials}
CRED_DIR=$(dirname "$CRED_FILE")
TMP_FILE="${CRED_FILE}.tmp.$$"

if [ "$(id -u)" -ne 0 ]; then
    echo "[yunbridge-rotate-credentials] Run as root." >&2
    exit 1
fi

umask 077
mkdir -p "$CRED_DIR"

if [ -f "$CRED_FILE" ]; then
    # shellcheck disable=SC1090
    . "$CRED_FILE"
fi

random_hex() {
    local length="$1"
    if command -v python3 >/dev/null 2>&1; then
        python3 - "$length" <<'PY'
import binascii
import os
import sys

length = int(sys.argv[1])
print(binascii.hexlify(os.urandom(length)).decode(), end="")
PY
        return
    fi

    if command -v hexdump >/dev/null 2>&1; then
        head -c "$length" /dev/urandom | hexdump -v -e '/1 "%02x"'
        return
    fi

    if command -v od >/dev/null 2>&1; then
        head -c "$length" /dev/urandom | od -An -tx1 | tr -d ' \n'
        return
    fi

    echo "[yunbridge-rotate-credentials] ERROR: Need python3, hexdump, or od to generate random hex." >&2
    return 1
}

random_b64() {
    local length="$1"
    if command -v python3 >/dev/null 2>&1; then
        python3 - "$length" <<'PY'
import base64
import os
import sys

length = int(sys.argv[1])
print(base64.b64encode(os.urandom(length)).decode().rstrip('='), end="")
PY
        return
    fi

    if command -v base64 >/dev/null 2>&1; then
        head -c "$length" /dev/urandom | base64 | tr -d '\n='
        return
    fi

    # Absolute fallback: reuse hex output (still random ASCII, though longer)
    random_hex "$length"
}

YUNBRIDGE_SERIAL_SECRET=${YUNBRIDGE_SERIAL_SECRET:-""}
YUNBRIDGE_MQTT_USER=${YUNBRIDGE_MQTT_USER:-"yunbridge"}
YUNBRIDGE_MQTT_PASS=${YUNBRIDGE_MQTT_PASS:-""}
YUNBRIDGE_MQTT_CAFILE=${YUNBRIDGE_MQTT_CAFILE:-"/etc/yunbridge/tls/ca.crt"}
YUNBRIDGE_MQTT_CERTFILE=${YUNBRIDGE_MQTT_CERTFILE:-"/etc/yunbridge/tls/client.crt"}
YUNBRIDGE_MQTT_KEYFILE=${YUNBRIDGE_MQTT_KEYFILE:-"/etc/yunbridge/tls/client.key"}

YUNBRIDGE_SERIAL_SECRET="$(random_hex 32)"
if [ -z "$YUNBRIDGE_SERIAL_SECRET" ]; then
    echo "[yunbridge-rotate-credentials] ERROR: Failed to generate serial secret." >&2
    exit 1
fi

YUNBRIDGE_MQTT_PASS="$(random_b64 32)"
if [ -z "$YUNBRIDGE_MQTT_PASS" ]; then
    echo "[yunbridge-rotate-credentials] ERROR: Failed to generate MQTT password." >&2
    exit 1
fi

cat >"$TMP_FILE" <<EOF
YUNBRIDGE_SERIAL_SECRET=$YUNBRIDGE_SERIAL_SECRET
YUNBRIDGE_MQTT_USER=$YUNBRIDGE_MQTT_USER
YUNBRIDGE_MQTT_PASS=$YUNBRIDGE_MQTT_PASS
YUNBRIDGE_MQTT_CAFILE=$YUNBRIDGE_MQTT_CAFILE
YUNBRIDGE_MQTT_CERTFILE=$YUNBRIDGE_MQTT_CERTFILE
YUNBRIDGE_MQTT_KEYFILE=$YUNBRIDGE_MQTT_KEYFILE
EOF

mv "$TMP_FILE" "$CRED_FILE"
chmod 600 "$CRED_FILE"

if command -v /etc/init.d/yunbridge >/dev/null 2>&1; then
    /etc/init.d/yunbridge restart >/dev/null 2>&1 || true
fi

echo "[yunbridge-rotate-credentials] Updated $CRED_FILE and restarted YunBridge." >&2
