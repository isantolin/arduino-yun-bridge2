# Auto-generated protocol specification source for Yun Bridge v2.
# Any modifications here should be reflected by re-running tools/protocol/generate.py.

[constants]
protocol_version = 0x02
default_baudrate = 115200
default_safe_baudrate = 115200
max_payload_size = 128
rpc_buffer_size = 128
max_filepath_length = 64
max_datastore_key_length = 32
default_ack_timeout_ms = 200
default_retry_limit = 5
max_pending_tx_frames = 2
invalid_id_sentinel = 0xFFFF
response_offset = 0x80
uint8_mask = 0xFF
uint16_max = 0xFFFF
process_default_exit_code = 0xFF
crc32_mask = 0xFFFFFFFF
crc_initial = 0xFFFFFFFF
crc_polynomial = 0xEDB88320
frame_delimiter = 0x00
digital_low = 0x00
digital_high = 0x01
test_payload_byte = 0xAA
test_marker_byte = 0x55
test_exit_code = 0x7F
system_command_max = 0x4F

[handshake]
nonce_length = 16
tag_length = 16
tag_algorithm = "HMAC-SHA256"
tag_description = "HMAC-SHA256(secret, nonce) truncated to 16 bytes"
config_format = ">HBI"
config_description = "Serialized timing config: ack_timeout_ms (uint16), ack_retry_limit (uint8), response_timeout_ms (uint32)"
ack_timeout_min_ms = 25
ack_timeout_max_ms = 60000
response_timeout_min_ms = 100
response_timeout_max_ms = 180000
retry_limit_min = 1
retry_limit_max = 8

[data_formats]
datastore_key_len_format = ">B"
datastore_value_len_format = ">B"
crc_covered_header_format = ">BHH"
crc_format = ">I"
uint8_format = ">B"
uint16_format = ">H"
uint32_format = ">I"
pin_read_format = ">B"
pin_write_format = ">BB"

[mqtt_suffixes]
incoming_available = "incoming_available"
outgoing_available = "outgoing_available"
response = "response"

[[topics]]
name = "ANALOG"
value = "a"
description = "Analog pin operations"
[[topics]]
name = "CONSOLE"
value = "console"
description = "Remote console"
[[topics]]
name = "DATASTORE"
value = "datastore"
description = "Key-value storage"
[[topics]]
name = "DIGITAL"
value = "d"
description = "Digital pin operations"
[[topics]]
name = "FILE"
value = "file"
description = "File system operations"
[[topics]]
name = "MAILBOX"
value = "mailbox"
description = "Message passing"
[[topics]]
name = "SHELL"
value = "sh"
description = "Shell command execution"
[[topics]]
name = "STATUS"
value = "status"
description = "System status reporting"
[[topics]]
name = "SYSTEM"
value = "system"
description = "System control and info"

[[actions]]
name = "FILE_READ"
value = "read"
description = "Read file content"
[[actions]]
name = "FILE_WRITE"
value = "write"
description = "Write file content"
[[actions]]
name = "FILE_REMOVE"
value = "remove"
description = "Remove file"
[[actions]]
name = "SHELL_RUN"
value = "run"
description = "Run shell command"
[[actions]]
name = "SHELL_RUN_ASYNC"
value = "run_async"
description = "Run shell command asynchronously"
[[actions]]
name = "SHELL_POLL"
value = "poll"
description = "Poll shell command status"
[[actions]]
name = "SHELL_KILL"
value = "kill"
description = "Kill shell command"
[[actions]]
name = "MAILBOX_WRITE"
value = "write"
description = "Write to mailbox"
[[actions]]
name = "DATASTORE_GET"
value = "get"
description = "Get datastore value"
[[actions]]
name = "DATASTORE_PUT"
value = "put"
description = "Put datastore value"
[[actions]]
name = "PIN_MODE"
value = "mode"
description = "Set pin mode"
[[actions]]
name = "PIN_READ"
value = "read"
description = "Read pin value"
[[actions]]
name = "CONSOLE_IN"
value = "in"
description = "Console input"
[[actions]]
name = "MAILBOX_READ"
value = "read"
description = "Read from mailbox"
[[actions]]
name = "SYSTEM_FREE_MEMORY"
value = "free_memory"
description = "System free memory"
[[actions]]
name = "SYSTEM_VERSION"
value = "version"
description = "System version"
[[actions]]
name = "SYSTEM_GET"
value = "get"
description = "Get system info"
[[actions]]
name = "DIGITAL_WRITE"
value = "write"
description = "Digital write"
[[actions]]
name = "DIGITAL_READ"
value = "read"
description = "Digital read"
[[actions]]
name = "DIGITAL_MODE"
value = "mode"
description = "Digital mode"
[[actions]]
name = "ANALOG_WRITE"
value = "write"
description = "Analog write"
[[actions]]
name = "ANALOG_READ"
value = "read"
description = "Analog read"
[[actions]]
name = "CONSOLE_INPUT"
value = "input"
description = "Console input action"

# --- STATUS CODES REASSIGNED TO SAFE RANGE 0x30-0x3F ---
[[statuses]]
name = "OK"
value = 0x30
description = "Operation completed successfully."
[[statuses]]
name = "ERROR"
value = 0x31
description = "Generic failure."
[[statuses]]
name = "CMD_UNKNOWN"
value = 0x32
description = "Command not recognized."
[[statuses]]
name = "MALFORMED"
value = 0x33
description = "Payload had invalid structure."
[[statuses]]
name = "OVERFLOW"
value = 0x34
description = "Frame exceeded buffer size."
[[statuses]]
name = "CRC_MISMATCH"
value = 0x35
description = "CRC check failed."
[[statuses]]
name = "TIMEOUT"
value = 0x36
description = "Operation timed out."
[[statuses]]
name = "NOT_IMPLEMENTED"
value = 0x37
description = "Command defined but not supported."
[[statuses]]
name = "ACK"
value = 0x38
description = "Generic acknowledgement for fire-and-forget commands."

# --- SYSTEM COMMANDS REASSIGNED TO 0x40-0x4F ---

[[commands]]
name = "CMD_GET_VERSION"
value = 0x40
category = "system"
directions = ["linux_to_mcu"]
[[commands]]
name = "CMD_GET_VERSION_RESP"
value = 0x41
category = "system"
directions = ["mcu_to_linux"]
[[commands]]
name = "CMD_GET_FREE_MEMORY"
value = 0x42
category = "system"
directions = ["linux_to_mcu"]
[[commands]]
name = "CMD_GET_FREE_MEMORY_RESP"
value = 0x43
category = "system"
directions = ["mcu_to_linux"]
[[commands]]
name = "CMD_LINK_SYNC"
value = 0x44
category = "system"
directions = ["linux_to_mcu"]
[[commands]]
name = "CMD_LINK_SYNC_RESP"
value = 0x45
category = "system"
directions = ["mcu_to_linux"]
[[commands]]
name = "CMD_LINK_RESET"
value = 0x46
category = "system"
directions = ["linux_to_mcu"]
description = "Reset link state. Accepts optional payload with 'config_format' to update timing parameters."
[[commands]]
name = "CMD_LINK_RESET_RESP"
value = 0x47
category = "system"
directions = ["mcu_to_linux"]
[[commands]]
name = "CMD_GET_TX_DEBUG_SNAPSHOT"
value = 0x48
category = "system"
directions = ["linux_to_mcu"]
[[commands]]
name = "CMD_GET_TX_DEBUG_SNAPSHOT_RESP"
value = 0x49
category = "system"
directions = ["mcu_to_linux"]
[[commands]]
name = "CMD_SET_BAUDRATE"
value = 0x4A
category = "system"
directions = ["linux_to_mcu"]
[[commands]]
name = "CMD_SET_BAUDRATE_RESP"
value = 0x4B
category = "system"
directions = ["mcu_to_linux"]

[[commands]]
name = "CMD_XOFF"
value = 0x4E
description = "Pause transmission (Flow Control)"
directions = ["mcu_to_linux"]
requires_ack = false

[[commands]]
name = "CMD_XON"
value = 0x4F
description = "Resume transmission (Flow Control)"
directions = ["mcu_to_linux"]
requires_ack = false

# --- GPIO COMMANDS REASSIGNED TO 0x50-0x5F ---
[[commands]]
name = "CMD_SET_PIN_MODE"
value = 0x50
category = "gpio"
directions = ["linux_to_mcu"]
requires_ack = true
[[commands]]
name = "CMD_DIGITAL_WRITE"
value = 0x51
category = "gpio"
directions = ["linux_to_mcu"]
requires_ack = true
[[commands]]
name = "CMD_ANALOG_WRITE"
value = 0x52
category = "gpio"
directions = ["linux_to_mcu"]
requires_ack = true
[[commands]]
name = "CMD_DIGITAL_READ"
value = 0x53
category = "gpio"
directions = ["linux_to_mcu"]
[[commands]]
name = "CMD_ANALOG_READ"
value = 0x54
category = "gpio"
directions = ["linux_to_mcu"]
[[commands]]
name = "CMD_DIGITAL_READ_RESP"
value = 0x55
category = "gpio"
directions = ["mcu_to_linux"]
[[commands]]
name = "CMD_ANALOG_READ_RESP"
value = 0x56
category = "gpio"
directions = ["mcu_to_linux"]

# --- CONSOLE COMMANDS REASSIGNED TO 0x60 ---
[[commands]]
name = "CMD_CONSOLE_WRITE"
value = 0x60
category = "console"
directions = ["linux_to_mcu", "mcu_to_linux"]
requires_ack = true

# --- DATASTORE COMMANDS REASSIGNED TO 0x70 ---
[[commands]]
name = "CMD_DATASTORE_PUT"
value = 0x70
category = "datastore"
directions = ["mcu_to_linux"]
requires_ack = true
[[commands]]
name = "CMD_DATASTORE_GET"
value = 0x71
category = "datastore"
directions = ["mcu_to_linux"]
[[commands]]
name = "CMD_DATASTORE_GET_RESP"
value = 0x72
category = "datastore"
directions = ["linux_to_mcu"]

# --- MAILBOX COMMANDS REASSIGNED TO 0x80 ---
[[commands]]
name = "CMD_MAILBOX_READ"
value = 0x80
category = "mailbox"
directions = ["mcu_to_linux"]
[[commands]]
name = "CMD_MAILBOX_PROCESSED"
value = 0x81
category = "mailbox"
directions = ["mcu_to_linux"]
[[commands]]
name = "CMD_MAILBOX_AVAILABLE"
value = 0x82
category = "mailbox"
directions = ["mcu_to_linux"]
[[commands]]
name = "CMD_MAILBOX_PUSH"
value = 0x83
category = "mailbox"
directions = ["linux_to_mcu", "mcu_to_linux"]
[[commands]]
name = "CMD_MAILBOX_READ_RESP"
value = 0x84
category = "mailbox"
directions = ["linux_to_mcu"]
[[commands]]
name = "CMD_MAILBOX_AVAILABLE_RESP"
value = 0x85
category = "mailbox"
directions = ["linux_to_mcu"]

# --- FILESYSTEM COMMANDS REASSIGNED TO 0x90 ---
[[commands]]
name = "CMD_FILE_WRITE"
value = 0x90
category = "filesystem"
directions = ["linux_to_mcu", "mcu_to_linux"]
[[commands]]
name = "CMD_FILE_READ"
value = 0x91
category = "filesystem"
directions = ["mcu_to_linux"]
[[commands]]
name = "CMD_FILE_REMOVE"
value = 0x92
category = "filesystem"
directions = ["mcu_to_linux"]
[[commands]]
name = "CMD_FILE_READ_RESP"
value = 0x93
category = "filesystem"
directions = ["linux_to_mcu"]

# --- PROCESS COMMANDS REASSIGNED TO 0xA0 ---
[[commands]]
name = "CMD_PROCESS_RUN"
value = 0xA0
category = "process"
directions = ["mcu_to_linux"]
[[commands]]
name = "CMD_PROCESS_RUN_ASYNC"
value = 0xA1
category = "process"
directions = ["mcu_to_linux"]
[[commands]]
name = "CMD_PROCESS_POLL"
value = 0xA2
category = "process"
directions = ["mcu_to_linux"]
[[commands]]
name = "CMD_PROCESS_KILL"
value = 0xA3
category = "process"
directions = ["mcu_to_linux"]
[[commands]]
name = "CMD_PROCESS_RUN_RESP"
value = 0xA4
category = "process"
directions = ["linux_to_mcu"]
[[commands]]
name = "CMD_PROCESS_RUN_ASYNC_RESP"
value = 0xA5
category = "process"
directions = ["linux_to_mcu"]
[[commands]]
name = "CMD_PROCESS_POLL_RESP"
value = 0xA6
category = "process"
directions = ["linux_to_mcu"]