name: Emulation Test (SimAVR)

on:
  push:
    paths:
      - 'openwrt-library-arduino/**'
      - 'openwrt-yun-bridge/**'
      - 'tools/**'
  pull_request:
    paths:
      - 'openwrt-library-arduino/**'
      - 'openwrt-yun-bridge/**'
      - 'tools/**'

jobs:
  test-emulation:
    name: Full System Emulation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install SimAVR and Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y simavr avr-libc gcc-avr python3-pip socat

      - name: Install Arduino CLI
        uses: arduino/setup-arduino-cli@v1

      - name: Install tooling
        run: |
          python -m pip install --upgrade pip
          pip install tox

      - name: Compile Firmware for Emulation
        run: |
          # Use the unified CI script to compile and save artifacts
          # We pass a build directory to keep the .elf files
          mkdir -p openwrt-library-arduino/build
          ./tools/ci_arduino.sh openwrt-library-arduino/build

      - name: Run Emulation Harness
        # Now we can point the runner to the real compiled ELF
        run: |
          # Install python dependencies for the runner if needed
          pip install -r requirements/runtime.txt
          python3 tools/emulation_runner.py