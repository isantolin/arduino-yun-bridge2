"""Shared constants for Yun Bridge daemon components."""

from __future__ import annotations

from ssl import TLSVersion

from .protocol.topics import Topic
from .rpc import protocol as rpc_protocol
from .rpc.protocol import Status


FRAME_DELIMITER: bytes = rpc_protocol.FRAME_DELIMITER
STATUS_FILE_PATH: str = "/tmp/yunbridge_status.json"
ALLOWED_COMMAND_WILDCARD: str = "*"
MQTT_TLS_MIN_VERSION: TLSVersion = TLSVersion.TLSv1_2

DEFAULT_SERIAL_PORT: str = "/dev/ttyATH0"
DEFAULT_SERIAL_BAUD: int = rpc_protocol.DEFAULT_BAUDRATE
DEFAULT_SERIAL_SAFE_BAUD: int = 115200
DEFAULT_MQTT_HOST: str = "127.0.0.1"
DEFAULT_MQTT_PORT: int = 8883
DEFAULT_MQTT_TOPIC: str = "br"
DEFAULT_MQTT_CAFILE: str = "/etc/ssl/certs/ca-certificates.crt"
DEFAULT_FILE_SYSTEM_ROOT: str = "/root/yun_files"
DEFAULT_FILE_WRITE_MAX_BYTES: int = 262144
DEFAULT_FILE_STORAGE_QUOTA_BYTES: int = 4194304
DEFAULT_PROCESS_TIMEOUT: int = 10
DEFAULT_MQTT_QUEUE_LIMIT: int = 256
DEFAULT_RECONNECT_DELAY: int = 5
DEFAULT_STATUS_INTERVAL: int = 5
DEFAULT_CONSOLE_QUEUE_LIMIT_BYTES: int = 16384
DEFAULT_MAILBOX_QUEUE_LIMIT: int = 64
DEFAULT_MAILBOX_QUEUE_BYTES_LIMIT: int = 65536
DEFAULT_PENDING_PIN_REQUESTS: int = 32
DEFAULT_SERIAL_RETRY_TIMEOUT: float = 0.75
DEFAULT_SERIAL_RESPONSE_TIMEOUT: float = 3.0
DEFAULT_SERIAL_RETRY_ATTEMPTS: int = rpc_protocol.DEFAULT_RETRY_LIMIT
DEFAULT_SERIAL_HANDSHAKE_MIN_INTERVAL: float = 0.0
SERIAL_HANDSHAKE_BACKOFF_BASE: float = 1.0
SERIAL_HANDSHAKE_BACKOFF_MAX: float = 60.0
SERIAL_NONCE_LENGTH: int = rpc_protocol.HANDSHAKE_NONCE_LENGTH
SERIAL_HANDSHAKE_TAG_LEN: int = rpc_protocol.HANDSHAKE_TAG_LENGTH
SERIAL_HANDSHAKE_TAG_ALGORITHM: str = rpc_protocol.HANDSHAKE_TAG_ALGORITHM
SERIAL_HANDSHAKE_TAG_DESCRIPTION: str = rpc_protocol.HANDSHAKE_TAG_DESCRIPTION
SERIAL_HANDSHAKE_CONFIG_FORMAT: str = rpc_protocol.HANDSHAKE_CONFIG_FORMAT
SERIAL_HANDSHAKE_ACK_TIMEOUT_MIN_MS: int = rpc_protocol.HANDSHAKE_ACK_TIMEOUT_MIN_MS
SERIAL_HANDSHAKE_ACK_TIMEOUT_MAX_MS: int = rpc_protocol.HANDSHAKE_ACK_TIMEOUT_MAX_MS
SERIAL_RESPONSE_TIMEOUT_MIN_MS: int = rpc_protocol.HANDSHAKE_RESPONSE_TIMEOUT_MIN_MS
SERIAL_RESPONSE_TIMEOUT_MAX_MS: int = rpc_protocol.HANDSHAKE_RESPONSE_TIMEOUT_MAX_MS
SERIAL_RETRY_LIMIT_MIN: int = rpc_protocol.HANDSHAKE_RETRY_LIMIT_MIN
SERIAL_RETRY_LIMIT_MAX: int = rpc_protocol.HANDSHAKE_RETRY_LIMIT_MAX
MIN_SERIAL_SHARED_SECRET_LEN: int = 8
# SECURITY WARNING: This default secret is for initial setup only.
# It MUST be rotated using 'yunbridge-rotate-credentials' before production use.
DEFAULT_SERIAL_SHARED_SECRET: bytes | None = None
DEFAULT_SERIAL_HANDSHAKE_FATAL_FAILURES: int = 3
SERIAL_MIN_ACK_TIMEOUT: float = 0.05
SERIAL_ACK_ONLY_COMMANDS: frozenset[int] = rpc_protocol.ACK_ONLY_COMMANDS
SERIAL_FAILURE_STATUS_CODES: frozenset[int] = frozenset(
    {
        Status.ERROR.value,
        Status.CMD_UNKNOWN.value,
        Status.MALFORMED.value,
        Status.CRC_MISMATCH.value,
        Status.TIMEOUT.value,
        Status.NOT_IMPLEMENTED.value,
    }
)
SERIAL_SUCCESS_STATUS_CODES: frozenset[int] = frozenset({Status.OK.value})
DEFAULT_MQTT_SPOOL_DIR: str = "/root/.yunbridge/mqtt_spool"
DEFAULT_PROCESS_MAX_OUTPUT_BYTES: int = 65536
DEFAULT_PROCESS_MAX_CONCURRENT: int = 4
DEFAULT_METRICS_HOST: str = "127.0.0.1"
DEFAULT_METRICS_PORT: int = 9130
DEFAULT_BRIDGE_SUMMARY_INTERVAL: int = 60
DEFAULT_BRIDGE_HANDSHAKE_INTERVAL: int = 300

TOPIC_ANALOG: str = Topic.ANALOG.value
TOPIC_CONSOLE: str = Topic.CONSOLE.value
TOPIC_DATASTORE: str = Topic.DATASTORE.value
TOPIC_DIGITAL: str = Topic.DIGITAL.value
TOPIC_FILE: str = Topic.FILE.value
TOPIC_MAILBOX: str = Topic.MAILBOX.value
TOPIC_MAILBOX_INCOMING_AVAILABLE: str = f"{Topic.MAILBOX.value}/{rpc_protocol.MQTT_SUFFIX_INCOMING_AVAILABLE}"
TOPIC_MAILBOX_OUTGOING_AVAILABLE: str = f"{Topic.MAILBOX.value}/{rpc_protocol.MQTT_SUFFIX_OUTGOING_AVAILABLE}"
TOPIC_SHELL: str = Topic.SHELL.value
TOPIC_STATUS: str = Topic.STATUS.value
TOPIC_SYSTEM: str = Topic.SYSTEM.value

WATCHDOG_TRIGGER_TOKEN: bytes = b"WATCHDOG=trigger\n"
DEFAULT_WATCHDOG_INTERVAL: float = 5.0

SUPERVISOR_DEFAULT_RESTART_INTERVAL: float = 60.0
SUPERVISOR_DEFAULT_MIN_BACKOFF: float = 1.0
SUPERVISOR_DEFAULT_MAX_BACKOFF: float = 30.0
TOPIC_FORBIDDEN_REASON: str = "topic-action-forbidden"

# Environment Variable Names
ENV_SERIAL_SECRET: str = "YUNBRIDGE_SERIAL_SECRET"
ENV_MQTT_CAFILE: str = "YUNBRIDGE_MQTT_CAFILE"
ENV_MQTT_CERTFILE: str = "YUNBRIDGE_MQTT_CERTFILE"
ENV_MQTT_KEYFILE: str = "YUNBRIDGE_MQTT_KEYFILE"
ENV_MQTT_USER: str = "YUNBRIDGE_MQTT_USER"
ENV_MQTT_PASS: str = "YUNBRIDGE_MQTT_PASS"
ENV_METRICS_ENABLED: str = "YUNBRIDGE_METRICS_ENABLED"
ENV_METRICS_HOST: str = "YUNBRIDGE_METRICS_HOST"
ENV_METRICS_PORT: str = "YUNBRIDGE_METRICS_PORT"
ENV_DISABLE_WATCHDOG: str = "YUNBRIDGE_DISABLE_WATCHDOG"
ENV_WATCHDOG_INTERVAL: str = "YUNBRIDGE_WATCHDOG_INTERVAL"
ENV_PROCD_WATCHDOG: str = "PROCD_WATCHDOG"
ENV_PROCD_WATCHDOG_MS: str = "YUNBRIDGE_PROCD_WATCHDOG_MS"
ENV_DEBUG: str = "YUNBRIDGE_DEBUG"
ENV_MQTT_SPOOL_DIR: str = "YUNBRIDGE_MQTT_SPOOL_DIR"
ENV_BRIDGE_SUMMARY_INTERVAL: str = "YUNBRIDGE_BRIDGE_SUMMARY_INTERVAL"
ENV_BRIDGE_HANDSHAKE_INTERVAL: str = "YUNBRIDGE_BRIDGE_HANDSHAKE_INTERVAL"

__all__ = [
    "FRAME_DELIMITER",
    "STATUS_FILE_PATH",
    "ALLOWED_COMMAND_WILDCARD",
    "MQTT_TLS_MIN_VERSION",
    "DEFAULT_SERIAL_PORT",
    "DEFAULT_SERIAL_BAUD",
    "DEFAULT_MQTT_HOST",
    "DEFAULT_MQTT_PORT",
    "DEFAULT_MQTT_TOPIC",
    "DEFAULT_MQTT_CAFILE",
    "DEFAULT_FILE_SYSTEM_ROOT",
    "DEFAULT_FILE_WRITE_MAX_BYTES",
    "DEFAULT_FILE_STORAGE_QUOTA_BYTES",
    "DEFAULT_PROCESS_TIMEOUT",
    "DEFAULT_MQTT_QUEUE_LIMIT",
    "DEFAULT_RECONNECT_DELAY",
    "DEFAULT_STATUS_INTERVAL",
    "DEFAULT_CONSOLE_QUEUE_LIMIT_BYTES",
    "DEFAULT_MAILBOX_QUEUE_LIMIT",
    "DEFAULT_MAILBOX_QUEUE_BYTES_LIMIT",
    "DEFAULT_PENDING_PIN_REQUESTS",
    "DEFAULT_SERIAL_RETRY_TIMEOUT",
    "DEFAULT_SERIAL_RESPONSE_TIMEOUT",
    "DEFAULT_SERIAL_RETRY_ATTEMPTS",
    "DEFAULT_SERIAL_HANDSHAKE_MIN_INTERVAL",
    "SERIAL_HANDSHAKE_BACKOFF_BASE",
    "SERIAL_HANDSHAKE_BACKOFF_MAX",
    "SERIAL_NONCE_LENGTH",
    "SERIAL_HANDSHAKE_TAG_LEN",
    "SERIAL_HANDSHAKE_TAG_ALGORITHM",
    "SERIAL_HANDSHAKE_TAG_DESCRIPTION",
    "SERIAL_HANDSHAKE_CONFIG_FORMAT",
    "SERIAL_HANDSHAKE_ACK_TIMEOUT_MIN_MS",
    "SERIAL_HANDSHAKE_ACK_TIMEOUT_MAX_MS",
    "SERIAL_RESPONSE_TIMEOUT_MIN_MS",
    "SERIAL_RESPONSE_TIMEOUT_MAX_MS",
    "SERIAL_RETRY_LIMIT_MIN",
    "SERIAL_RETRY_LIMIT_MAX",
    "MIN_SERIAL_SHARED_SECRET_LEN",
    "DEFAULT_SERIAL_SHARED_SECRET",
    "DEFAULT_SERIAL_HANDSHAKE_FATAL_FAILURES",
    "SERIAL_MIN_ACK_TIMEOUT",
    "SERIAL_ACK_ONLY_COMMANDS",
    "SERIAL_FAILURE_STATUS_CODES",
    "SERIAL_SUCCESS_STATUS_CODES",
    "DEFAULT_MQTT_SPOOL_DIR",
    "DEFAULT_PROCESS_MAX_OUTPUT_BYTES",
    "DEFAULT_PROCESS_MAX_CONCURRENT",
    "DEFAULT_METRICS_HOST",
    "DEFAULT_METRICS_PORT",
    "DEFAULT_BRIDGE_SUMMARY_INTERVAL",
    "DEFAULT_BRIDGE_HANDSHAKE_INTERVAL",
    "TOPIC_ANALOG",
    "TOPIC_CONSOLE",
    "TOPIC_DATASTORE",
    "TOPIC_DIGITAL",
    "TOPIC_FILE",
    "TOPIC_MAILBOX",
    "TOPIC_MAILBOX_INCOMING_AVAILABLE",
    "TOPIC_MAILBOX_OUTGOING_AVAILABLE",
    "TOPIC_SHELL",
    "TOPIC_STATUS",
    "TOPIC_SYSTEM",
    "WATCHDOG_TRIGGER_TOKEN",
    "DEFAULT_WATCHDOG_INTERVAL",
    "SUPERVISOR_DEFAULT_RESTART_INTERVAL",
    "SUPERVISOR_DEFAULT_MIN_BACKOFF",
    "SUPERVISOR_DEFAULT_MAX_BACKOFF",
    "TOPIC_FORBIDDEN_REASON",
    "ENV_SERIAL_SECRET",
    "ENV_MQTT_CAFILE",
    "ENV_MQTT_CERTFILE",
    "ENV_MQTT_KEYFILE",
    "ENV_MQTT_USER",
    "ENV_MQTT_PASS",
    "ENV_METRICS_ENABLED",
    "ENV_METRICS_HOST",
    "ENV_METRICS_PORT",
    "ENV_DISABLE_WATCHDOG",
    "ENV_WATCHDOG_INTERVAL",
    "ENV_PROCD_WATCHDOG",
    "ENV_PROCD_WATCHDOG_MS",
    "ENV_DEBUG",
    "ENV_MQTT_SPOOL_DIR",
    "ENV_BRIDGE_SUMMARY_INTERVAL",
    "ENV_BRIDGE_HANDSHAKE_INTERVAL",
]
