#!/bin/sh
# Run a basic YunBridge hardware smoke test locally on the device.
set -eu

if ! command -v mosquitto_pub >/dev/null 2>&1 || ! command -v mosquitto_sub >/dev/null 2>&1; then
    echo "[yunbridge-hw-smoke] mosquitto-client package is required." >&2
    exit 1
fi

STATUS_FILE="/tmp/yunbridge_status.json"

uci_get() {
    local key="$1"
    uci -q get "yunbridge.general.${key}" 2>/dev/null || true
}

MQTT_USER=$(uci_get mqtt_user)
MQTT_PASS=$(uci_get mqtt_pass)
MQTT_CAFILE=$(uci_get mqtt_cafile)
MQTT_CERTFILE=$(uci_get mqtt_certfile)
MQTT_KEYFILE=$(uci_get mqtt_keyfile)
MQTT_TLS_INSECURE=$(uci_get mqtt_tls_insecure)
SERIAL_SECRET=$(uci_get serial_shared_secret)

if [ -z "$SERIAL_SECRET" ] || [ "$SERIAL_SECRET" = "changeme123" ]; then
    echo "[yunbridge-hw-smoke] Serial secret missing or still using the placeholder value." >&2
    exit 1
fi

HOST=$(uci_get mqtt_host)
HOST=${HOST:-127.0.0.1}
PORT=$(uci_get mqtt_port)
PORT=${PORT:-8883}
TOPIC=$(uci_get mqtt_topic)
TOPIC=${TOPIC:-br}
TLS=$(uci_get mqtt_tls)
TLS=${TLS:-1}

if ! /etc/init.d/yunbridge status >/dev/null 2>&1; then
    echo "[yunbridge-hw-smoke] YunBridge service is not running." >&2
    exit 1
fi

if [ ! -s "$STATUS_FILE" ]; then
    echo "[yunbridge-hw-smoke] Status file $STATUS_FILE missing or empty." >&2
    exit 1
fi

echo "[yunbridge-hw-smoke] Checking MQTT round trip via ${HOST}:${PORT}..." >&2
TMP_SUB="/tmp/yunbridge-smoke.$$"
trap 'rm -f "$TMP_SUB"' EXIT INT TERM

MOSQUITTO_SUB_ARGS="-h $HOST -p $PORT -t ${TOPIC}/system/status -C 1 -W 7"
MOSQUITTO_PUB_ARGS="-h $HOST -p $PORT -t ${TOPIC}/system/status/request -m {\"request\":\"ping\"}"

if [ "$TLS" = "1" ]; then
    if [ -n "$MQTT_CAFILE" ] && [ ! -s "$MQTT_CAFILE" ]; then
        echo "[yunbridge-hw-smoke] TLS cafile is set but missing/empty: $MQTT_CAFILE" >&2
        exit 1
    fi
    if [ -n "$MQTT_CERTFILE" ] || [ -n "$MQTT_KEYFILE" ]; then
        if [ -z "$MQTT_CERTFILE" ] || [ -z "$MQTT_KEYFILE" ]; then
            echo "[yunbridge-hw-smoke] TLS client auth requires both mqtt_certfile and mqtt_keyfile." >&2
            exit 1
        fi
        if [ ! -s "$MQTT_CERTFILE" ] || [ ! -s "$MQTT_KEYFILE" ]; then
            echo "[yunbridge-hw-smoke] TLS client auth material missing/empty: $MQTT_CERTFILE / $MQTT_KEYFILE" >&2
            exit 1
        fi
    fi
    if [ -n "$MQTT_CAFILE" ]; then
        MOSQUITTO_SUB_ARGS="$MOSQUITTO_SUB_ARGS --cafile $MQTT_CAFILE"
        MOSQUITTO_PUB_ARGS="$MOSQUITTO_PUB_ARGS --cafile $MQTT_CAFILE"
    fi
    if [ "${MQTT_TLS_INSECURE:-0}" = "1" ]; then
        MOSQUITTO_SUB_ARGS="$MOSQUITTO_SUB_ARGS --insecure"
        MOSQUITTO_PUB_ARGS="$MOSQUITTO_PUB_ARGS --insecure"
    fi
    if [ -n "$MQTT_CERTFILE" ] && [ -n "$MQTT_KEYFILE" ]; then
        MOSQUITTO_SUB_ARGS="$MOSQUITTO_SUB_ARGS --cert $MQTT_CERTFILE --key $MQTT_KEYFILE"
        MOSQUITTO_PUB_ARGS="$MOSQUITTO_PUB_ARGS --cert $MQTT_CERTFILE --key $MQTT_KEYFILE"
    fi
    if [ -z "$MQTT_CAFILE" ]; then
        if [ -s "/etc/ssl/certs/ca-certificates.crt" ]; then
            MOSQUITTO_SUB_ARGS="$MOSQUITTO_SUB_ARGS --cafile /etc/ssl/certs/ca-certificates.crt"
            MOSQUITTO_PUB_ARGS="$MOSQUITTO_PUB_ARGS --cafile /etc/ssl/certs/ca-certificates.crt"
        elif [ -d "/etc/ssl/certs" ]; then
            MOSQUITTO_SUB_ARGS="$MOSQUITTO_SUB_ARGS --capath /etc/ssl/certs"
            MOSQUITTO_PUB_ARGS="$MOSQUITTO_PUB_ARGS --capath /etc/ssl/certs"
        fi
    fi
fi

if [ -n "$MQTT_USER" ]; then
    MOSQUITTO_SUB_ARGS="$MOSQUITTO_SUB_ARGS -u $MQTT_USER"
    MOSQUITTO_PUB_ARGS="$MOSQUITTO_PUB_ARGS -u $MQTT_USER"
fi
if [ -n "$MQTT_PASS" ]; then
    MOSQUITTO_SUB_ARGS="$MOSQUITTO_SUB_ARGS -P $MQTT_PASS"
    MOSQUITTO_PUB_ARGS="$MOSQUITTO_PUB_ARGS -P $MQTT_PASS"
fi

# shellcheck disable=SC2086
mosquitto_sub $MOSQUITTO_SUB_ARGS >"$TMP_SUB" &
SUB_PID=$!
sleep 1
# shellcheck disable=SC2086
mosquitto_pub $MOSQUITTO_PUB_ARGS >/dev/null

if ! wait "$SUB_PID" >/dev/null 2>&1; then
    echo "[yunbridge-hw-smoke] Did not receive response from daemon." >&2
    exit 1
fi

echo "[yunbridge-hw-smoke] Received response:"
cat "$TMP_SUB"

echo "[yunbridge-hw-smoke] Smoke test completed successfully." >&2
