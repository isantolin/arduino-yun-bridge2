# Auto-generated protocol specification source for Yun Bridge v2.
# Any modifications here should be reflected by re-running tools/protocol/generate.py.

[constants]
protocol_version = 0x02
default_baudrate = 115200
default_safe_baudrate = 115200
max_payload_size = 128
max_filepath_length = 64
max_datastore_key_length = 32
default_ack_timeout_ms = 200
default_retry_limit = 5
max_pending_tx_frames = 2
invalid_id_sentinel = 0xFFFF
uint8_mask = 0xFF
uint16_max = 0xFFFF
process_default_exit_code = 0xFF
crc32_mask = 0xFFFFFFFF
crc_initial = 0xFFFFFFFF
crc_polynomial = 0xEDB88320
frame_delimiter = 0x00
digital_low = 0x00
digital_high = 0x01
status_code_min = 0x30
status_code_max = 0x3F
system_command_min = 0x40
system_command_max = 0x4F
gpio_command_min = 0x50

# RLE compression constants
rle_escape_byte = 0xFF
rle_min_run_length = 4
rle_max_run_length = 256
rle_single_escape_marker = 0xFF

[compression]
none = 0x00
rle = 0x01

[handshake]
nonce_length = 16
tag_length = 16
tag_algorithm = "HMAC-SHA256"
tag_description = "HMAC-SHA256(secret, nonce) truncated to 16 bytes"
config_format = ">HBI"
config_description = "Serialized timing config: ack_timeout_ms (uint16), ack_retry_limit (uint8), response_timeout_ms (uint32)"
ack_timeout_min_ms = 25
ack_timeout_max_ms = 60000
response_timeout_min_ms = 100
response_timeout_max_ms = 180000
retry_limit_min = 1
retry_limit_max = 8

# [MIL-SPEC] HKDF key derivation parameters (NIST SP 800-56C)
hkdf_algorithm = "HKDF-SHA256"
hkdf_salt = "yunbridge-v2"
hkdf_info_auth = "handshake-auth"
hkdf_output_length = 32

# [MIL-SPEC] Anti-replay nonce structure
nonce_random_bytes = 8
nonce_counter_bytes = 8
nonce_format_description = "random[8] || counter[8] - counter is big-endian uint64 for anti-replay"

[data_formats]
datastore_key_len_format = ">B"
datastore_value_len_format = ">B"
crc_covered_header_format = ">BHH"
crc_format = ">I"
uint8_format = ">B"
uint16_format = ">H"
uint32_format = ">I"
pin_read_format = ">B"
pin_write_format = ">BB"

[mqtt_suffixes]
incoming_available = "incoming_available"
outgoing_available = "outgoing_available"
response = "response"
error = "error"

[mqtt_defaults]
default_topic_prefix = "br"

[status_reasons]
invalid_path = "invalid_path"
read_failed = "read_failed"
remove_failed = "remove_failed"
write_failed = "write_failed"
mailbox_incoming_overflow = "mailbox_incoming_overflow"
mailbox_outgoing_overflow = "mailbox_outgoing_overflow"
process_limit_reached = "process_limit_reached"
command_validation_failed = "command_validation_failed"
process_run_async_failed = "process_run_async_failed"
process_run_internal_error = "process_run_internal_error"
process_kill_malformed = "process_kill_malformed"
process_not_found = "process_not_found"
process_kill_failed = "process_kill_failed"

# MQTT command subscriptions (daemon inbound).
# These define which topics the daemon must subscribe to in order to receive
# commands via MQTT. They are intentionally expressed relative to the runtime
# prefix (e.g. "br") so deployments can override the prefix.
#
# Wildcards:
# - "+" matches exactly one segment
# - "#" matches zero or more segments

[[mqtt_subscriptions]]
topic = "DIGITAL"
segments = ["+", "mode"]
qos = 0

[[mqtt_subscriptions]]
topic = "DIGITAL"
segments = ["+", "read"]
qos = 0

[[mqtt_subscriptions]]
topic = "DIGITAL"
segments = ["+"]
qos = 0

[[mqtt_subscriptions]]
topic = "ANALOG"
segments = ["+", "read"]
qos = 0

[[mqtt_subscriptions]]
topic = "ANALOG"
segments = ["+"]
qos = 0

[[mqtt_subscriptions]]
topic = "CONSOLE"
segments = ["in"]
qos = 0

[[mqtt_subscriptions]]
topic = "DATASTORE"
segments = ["put", "#"]
qos = 0

[[mqtt_subscriptions]]
topic = "DATASTORE"
segments = ["get", "#"]
qos = 0

[[mqtt_subscriptions]]
topic = "MAILBOX"
segments = ["write"]
qos = 0

[[mqtt_subscriptions]]
topic = "MAILBOX"
segments = ["read"]
qos = 0

[[mqtt_subscriptions]]
topic = "SHELL"
segments = ["run"]
qos = 0

[[mqtt_subscriptions]]
topic = "SHELL"
segments = ["run_async"]
qos = 0

[[mqtt_subscriptions]]
topic = "SHELL"
segments = ["poll", "#"]
qos = 0

[[mqtt_subscriptions]]
topic = "SHELL"
segments = ["kill", "#"]
qos = 0

[[mqtt_subscriptions]]
topic = "SYSTEM"
segments = ["free_memory", "get"]
qos = 0

[[mqtt_subscriptions]]
topic = "SYSTEM"
segments = ["version", "get"]
qos = 0

# Bridge snapshots (daemon inbound): keep in sync with BridgeDispatcher._handle_bridge_topic
[[mqtt_subscriptions]]
topic = "SYSTEM"
segments = ["bridge", "handshake", "get"]
qos = 0

[[mqtt_subscriptions]]
topic = "SYSTEM"
segments = ["bridge", "summary", "get"]
qos = 0

[[mqtt_subscriptions]]
topic = "SYSTEM"
segments = ["bridge", "state", "get"]
qos = 0

[[mqtt_subscriptions]]
topic = "FILE"
segments = ["write", "#"]
qos = 0

[[mqtt_subscriptions]]
topic = "FILE"
segments = ["read", "#"]
qos = 0

[[mqtt_subscriptions]]
topic = "FILE"
segments = ["remove", "#"]
qos = 0

[[topics]]
name = "ANALOG"
value = "a"
description = "Analog pin operations"
[[topics]]
name = "CONSOLE"
value = "console"
description = "Remote console"
[[topics]]
name = "DATASTORE"
value = "datastore"
description = "Key-value storage"
[[topics]]
name = "DIGITAL"
value = "d"
description = "Digital pin operations"
[[topics]]
name = "FILE"
value = "file"
description = "File system operations"
[[topics]]
name = "MAILBOX"
value = "mailbox"
description = "Message passing"
[[topics]]
name = "SHELL"
value = "sh"
description = "Shell command execution"
[[topics]]
name = "STATUS"
value = "status"
description = "System status reporting"
[[topics]]
name = "SYSTEM"
value = "system"
description = "System control and info"

[[actions]]
name = "FILE_READ"
value = "read"
description = "Read file content"
[[actions]]
name = "FILE_WRITE"
value = "write"
description = "Write file content"
[[actions]]
name = "FILE_REMOVE"
value = "remove"
description = "Remove file"
[[actions]]
name = "SHELL_RUN"
value = "run"
description = "Run shell command"
[[actions]]
name = "SHELL_RUN_ASYNC"
value = "run_async"
description = "Run shell command asynchronously"
[[actions]]
name = "SHELL_POLL"
value = "poll"
description = "Poll shell command status"
[[actions]]
name = "SHELL_KILL"
value = "kill"
description = "Kill shell command"
[[actions]]
name = "MAILBOX_WRITE"
value = "write"
description = "Write to mailbox"
[[actions]]
name = "DATASTORE_GET"
value = "get"
description = "Get datastore value"
[[actions]]
name = "DATASTORE_PUT"
value = "put"
description = "Put datastore value"
[[actions]]
name = "PIN_MODE"
value = "mode"
description = "Set pin mode"
[[actions]]
name = "PIN_READ"
value = "read"
description = "Read pin value"
[[actions]]
name = "CONSOLE_IN"
value = "in"
description = "Console input"
[[actions]]
name = "CONSOLE_OUT"
value = "out"
description = "Console output"
[[actions]]
name = "MAILBOX_READ"
value = "read"
description = "Read from mailbox"
[[actions]]
name = "MAILBOX_INCOMING"
value = "incoming"
description = "Mailbox incoming messages"
[[actions]]
name = "MAILBOX_PROCESSED"
value = "processed"
description = "Mailbox processed notifications"
[[actions]]
name = "MAILBOX_ERRORS"
value = "errors"
description = "Mailbox error topic"
[[actions]]
name = "SYSTEM_FREE_MEMORY"
value = "free_memory"
description = "System free memory"
[[actions]]
name = "SYSTEM_VERSION"
value = "version"
description = "System version"
[[actions]]
name = "SYSTEM_GET"
value = "get"
description = "Get system info"
[[actions]]
name = "SYSTEM_VALUE"
value = "value"
description = "Value payload segment"
[[actions]]
name = "SYSTEM_METRICS"
value = "metrics"
description = "Metrics topic"
[[actions]]
name = "SYSTEM_BRIDGE"
value = "bridge"
description = "Bridge snapshots"
[[actions]]
name = "SYSTEM_HANDSHAKE"
value = "handshake"
description = "Handshake snapshot"
[[actions]]
name = "SYSTEM_SUMMARY"
value = "summary"
description = "Bridge summary snapshot"
[[actions]]
name = "SYSTEM_STATE"
value = "state"
description = "Bridge state snapshot"
[[actions]]
name = "DIGITAL_WRITE"
value = "write"
description = "Digital write"
[[actions]]
name = "DIGITAL_READ"
value = "read"
description = "Digital read"
[[actions]]
name = "DIGITAL_MODE"
value = "mode"
description = "Digital mode"
[[actions]]
name = "ANALOG_WRITE"
value = "write"
description = "Analog write"
[[actions]]
name = "ANALOG_READ"
value = "read"
description = "Analog read"
[[actions]]
name = "CONSOLE_INPUT"
value = "input"
description = "Console input action"

# --- STATUS CODES REASSIGNED TO SAFE RANGE 0x30-0x3F ---
[[statuses]]
name = "OK"
value = 0x30
description = "Operation completed successfully."
[[statuses]]
name = "ERROR"
value = 0x31
description = "Generic failure."
[[statuses]]
name = "CMD_UNKNOWN"
value = 0x32
description = "Command not recognized."
[[statuses]]
name = "MALFORMED"
value = 0x33
description = "Payload had invalid structure."
[[statuses]]
name = "OVERFLOW"
value = 0x34
description = "Frame exceeded buffer size."
[[statuses]]
name = "CRC_MISMATCH"
value = 0x35
description = "CRC check failed."
[[statuses]]
name = "TIMEOUT"
value = 0x36
description = "Operation timed out."
[[statuses]]
name = "NOT_IMPLEMENTED"
value = 0x37
description = "Command defined but not supported."
[[statuses]]
name = "ACK"
value = 0x38
description = "Generic acknowledgement for fire-and-forget commands."

# --- SYSTEM COMMANDS REASSIGNED TO 0x40-0x4F ---

[[commands]]
name = "CMD_GET_VERSION"
value = 0x40
category = "system"
directions = ["linux_to_mcu"]
expects_direct_response = true
[[commands]]
name = "CMD_GET_VERSION_RESP"
value = 0x41
category = "system"
directions = ["mcu_to_linux"]
[[commands]]
name = "CMD_GET_FREE_MEMORY"
value = 0x42
category = "system"
directions = ["linux_to_mcu"]
expects_direct_response = true
[[commands]]
name = "CMD_GET_FREE_MEMORY_RESP"
value = 0x43
category = "system"
directions = ["mcu_to_linux"]
[[commands]]
name = "CMD_LINK_SYNC"
value = 0x44
category = "system"
directions = ["linux_to_mcu"]
[[commands]]
name = "CMD_LINK_SYNC_RESP"
value = 0x45
category = "system"
directions = ["mcu_to_linux"]
[[commands]]
name = "CMD_LINK_RESET"
value = 0x46
category = "system"
directions = ["linux_to_mcu"]
description = "Reset link state. Accepts optional payload with 'config_format' to update timing parameters."
[[commands]]
name = "CMD_LINK_RESET_RESP"
value = 0x47
category = "system"
directions = ["mcu_to_linux"]
[[commands]]
name = "CMD_SET_BAUDRATE"
value = 0x4A
category = "system"
directions = ["linux_to_mcu"]
[[commands]]
name = "CMD_SET_BAUDRATE_RESP"
value = 0x4B
category = "system"
directions = ["mcu_to_linux"]

[[commands]]
name = "CMD_XOFF"
value = 0x4E
description = "Pause transmission (Flow Control)"
directions = ["mcu_to_linux"]
requires_ack = false

[[commands]]
name = "CMD_XON"
value = 0x4F
description = "Resume transmission (Flow Control)"
directions = ["mcu_to_linux"]
requires_ack = false

# --- GPIO COMMANDS REASSIGNED TO 0x50-0x5F ---
[[commands]]
name = "CMD_SET_PIN_MODE"
value = 0x50
category = "gpio"
directions = ["linux_to_mcu"]
requires_ack = true
[[commands]]
name = "CMD_DIGITAL_WRITE"
value = 0x51
category = "gpio"
directions = ["linux_to_mcu"]
requires_ack = true
[[commands]]
name = "CMD_ANALOG_WRITE"
value = 0x52
category = "gpio"
directions = ["linux_to_mcu"]
requires_ack = true
[[commands]]
name = "CMD_DIGITAL_READ"
value = 0x53
category = "gpio"
directions = ["linux_to_mcu"]
expects_direct_response = true
[[commands]]
name = "CMD_ANALOG_READ"
value = 0x54
category = "gpio"
directions = ["linux_to_mcu"]
expects_direct_response = true
[[commands]]
name = "CMD_DIGITAL_READ_RESP"
value = 0x55
category = "gpio"
directions = ["mcu_to_linux"]
[[commands]]
name = "CMD_ANALOG_READ_RESP"
value = 0x56
category = "gpio"
directions = ["mcu_to_linux"]

# --- CONSOLE COMMANDS REASSIGNED TO 0x60 ---
[[commands]]
name = "CMD_CONSOLE_WRITE"
value = 0x60
category = "console"
directions = ["linux_to_mcu", "mcu_to_linux"]
requires_ack = true

# --- DATASTORE COMMANDS REASSIGNED TO 0x70 ---
[[commands]]
name = "CMD_DATASTORE_PUT"
value = 0x70
category = "datastore"
directions = ["mcu_to_linux"]
requires_ack = true
[[commands]]
name = "CMD_DATASTORE_GET"
value = 0x71
category = "datastore"
directions = ["mcu_to_linux"]
[[commands]]
name = "CMD_DATASTORE_GET_RESP"
value = 0x72
category = "datastore"
directions = ["linux_to_mcu"]

# --- MAILBOX COMMANDS REASSIGNED TO 0x80 ---
[[commands]]
name = "CMD_MAILBOX_READ"
value = 0x80
category = "mailbox"
directions = ["mcu_to_linux"]
[[commands]]
name = "CMD_MAILBOX_PROCESSED"
value = 0x81
category = "mailbox"
directions = ["mcu_to_linux"]
[[commands]]
name = "CMD_MAILBOX_AVAILABLE"
value = 0x82
category = "mailbox"
directions = ["mcu_to_linux"]
# Strict semantics:
# - Request MUST have an empty payload (payload_length == 0).
# - Any non-empty payload is rejected by Linux with STATUS_MALFORMED (payload: u16 command_id).
[[commands]]
name = "CMD_MAILBOX_PUSH"
value = 0x83
category = "mailbox"
directions = ["linux_to_mcu", "mcu_to_linux"]
requires_ack = true
[[commands]]
name = "CMD_MAILBOX_READ_RESP"
value = 0x84
category = "mailbox"
directions = ["linux_to_mcu"]
[[commands]]
name = "CMD_MAILBOX_AVAILABLE_RESP"
value = 0x85
category = "mailbox"
directions = ["linux_to_mcu"]

# --- FILESYSTEM COMMANDS REASSIGNED TO 0x90 ---
[[commands]]
name = "CMD_FILE_WRITE"
value = 0x90
category = "filesystem"
directions = ["linux_to_mcu", "mcu_to_linux"]
requires_ack = true
[[commands]]
name = "CMD_FILE_READ"
value = 0x91
category = "filesystem"
directions = ["mcu_to_linux"]
[[commands]]
name = "CMD_FILE_REMOVE"
value = 0x92
category = "filesystem"
directions = ["mcu_to_linux"]
[[commands]]
name = "CMD_FILE_READ_RESP"
value = 0x93
category = "filesystem"
directions = ["linux_to_mcu"]

# --- PROCESS COMMANDS REASSIGNED TO 0xA0 ---
[[commands]]
name = "CMD_PROCESS_RUN"
value = 0xA0
category = "process"
directions = ["mcu_to_linux"]
[[commands]]
name = "CMD_PROCESS_RUN_ASYNC"
value = 0xA1
category = "process"
directions = ["mcu_to_linux"]
[[commands]]
name = "CMD_PROCESS_POLL"
value = 0xA2
category = "process"
directions = ["mcu_to_linux"]
[[commands]]
name = "CMD_PROCESS_KILL"
value = 0xA3
category = "process"
directions = ["mcu_to_linux"]
[[commands]]
name = "CMD_PROCESS_RUN_RESP"
value = 0xA4
category = "process"
directions = ["linux_to_mcu"]
[[commands]]
name = "CMD_PROCESS_RUN_ASYNC_RESP"
value = 0xA5
category = "process"
directions = ["linux_to_mcu"]
[[commands]]
name = "CMD_PROCESS_POLL_RESP"
value = 0xA6
category = "process"
directions = ["linux_to_mcu"]