[tox]
# CAMBIO: Reemplazamos py311, py312 por py313
envlist = py313, protocol
isolated_build = false
skip_missing_interpreters = true
skipsdist = true

[testenv]
setenv =
    PYTHONPATH = {toxinidir}/openwrt-yun-bridge
    PYTHONWARNINGS = default
passenv =
    YUNBRIDGE_*
    PROCD_WATCHDOG
    LC_ALL
    LANG
deps =
    -r requirements/runtime.txt
    pytest
    pytest-asyncio
commands =
    pytest {posargs:openwrt-yun-bridge/tests}

[testenv:lint]
description = Run static analysis via Ruff and Flake8.
skip_install = true
deps =
    ruff==0.14.10
    flake8==7.3.0
commands =
    ruff check {posargs:openwrt-yun-bridge openwrt-yun-examples-python tools openwrt-yun-core/scripts}
    flake8 {posargs:openwrt-yun-bridge openwrt-yun-examples-python tools openwrt-yun-core/scripts}

[flake8]
max-line-length = 88
extend-ignore = E203, W503, E501, E704
exclude = .tox,*.egg,build,data
select = E,W,F

[testenv:coverage]
# CAMBIO: Actualizamos basepython a 3.13
basepython = python3.13
deps =
    {[testenv]deps}
    pytest-cov
    gcovr
allowlist_externals =
    ./tools/coverage_python.sh
    ./tools/coverage_arduino.sh
commands =
    ./tools/coverage_python.sh
    ./tools/coverage_arduino.sh

[testenv:lua]
description = Run static analysis for Lua code.
deps =
    hererocks
allowlist_externals =
    .tox/lua_env/bin/luarocks
    .tox/lua_env/bin/luacheck
commands =
    hererocks .tox/lua_env -l5.1 -rlatest
    .tox/lua_env/bin/luarocks install luacheck
    .tox/lua_env/bin/luacheck luci-app-yunbridge/luasrc

[testenv:protocol]
description = Ensure protocol bindings are regenerated.
skip_install = true
allowlist_externals = git
deps =
commands =
    python tools/protocol/generate.py --spec tools/protocol/spec.toml --py openwrt-yun-bridge/yunbridge/rpc/protocol.py --cpp openwrt-library-arduino/src/protocol/rpc_protocol.h
    git diff --exit-code openwrt-yun-bridge/yunbridge/rpc/protocol.py openwrt-library-arduino/src/protocol/rpc_protocol.h

[testenv:arduino]
description = Compile Arduino examples to verify they build correctly.
skip_install = true
deps =
allowlist_externals =
    ./tools/ci_arduino.sh
commands =
    ./tools/ci_arduino.sh

[testenv:typecheck]
description = Run static type checking via Pyright.
skip_install = true
deps =
    pyright
    -r requirements/runtime.txt
commands =
    pyright