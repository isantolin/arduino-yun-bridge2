py311: commands[0]> pytest --maxfail=1
============================= test session starts ==============================
platform linux -- Python 3.11.14, pytest-9.0.2, pluggy-1.6.0
cachedir: .tox/py311/.pytest_cache
rootdir: /home/ignaciosantolin/arduino-yun-bridge2
configfile: pytest.ini
testpaths: openwrt-yun-bridge/tests
plugins: asyncio-1.3.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=function, asyncio_default_test_loop_scope=function
collected 320 items

openwrt-yun-bridge/tests/test_bridge_components_pin_system.py F

=================================== FAILURES ===================================
_______________ test_mcu_digital_read_response_publishes_to_mqtt _______________

runtime_config = RuntimeConfig(serial_port='/dev/null', serial_baud=115200, serial_safe_baud=115200, mqtt_host='localhost', mqtt_port=8...bled=False, metrics_host='127.0.0.1', metrics_port=9130, bridge_summary_interval=60.0, bridge_handshake_interval=300.0)
runtime_state = RuntimeState(serial_writer=None, serial_link_connected=False, mqtt_publish_queue=<Queue at 0x7f2351f97b90 maxsize=8>, ..._ack_timeout_ms=25, serial_response_timeout_ms=3000, serial_retry_limit=1, mcu_status_counters={}, supervisor_stats={})

    def test_mcu_digital_read_response_publishes_to_mqtt(
        runtime_config: RuntimeConfig,
        runtime_state: RuntimeState,
    ) -> None:
        async def _run() -> None:
            service = BridgeService(runtime_config, runtime_state)
    
            sent_frames: list[tuple[int, bytes]] = []
    
            async def fake_sender(command_id: int, payload: bytes) -> bool:
                sent_frames.append((command_id, payload))
                return True
    
            service.register_serial_sender(fake_sender)
    
            runtime_state.pending_digital_reads.append(
                PendingPinRequest(pin=7, reply_context=None)
            )
    
            await service.handle_mcu_frame(
                Command.CMD_DIGITAL_READ_RESP.value,
                bytes([1]),
            )
    
            queued = runtime_state.mqtt_publish_queue.get_nowait()
            expected_topic = topic_path(
                runtime_state.mqtt_topic_prefix,
                Topic.DIGITAL,
                "7",
                "value",
            )
            assert queued.topic_name == expected_topic
            assert queued.payload == b"1"
            runtime_state.mqtt_publish_queue.task_done()
    
            assert sent_frames
            ack_id, ack_payload = sent_frames[-1]
            assert ack_id == Status.ACK.value
            assert ack_payload == struct.pack(">H", Command.CMD_DIGITAL_READ_RESP.value)
    
>       asyncio.run(_run())

openwrt-yun-bridge/tests/test_bridge_components_pin_system.py:79: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 
/usr/lib64/python3.11/asyncio/runners.py:190: in run
    return runner.run(main)
           ^^^^^^^^^^^^^^^^
/usr/lib64/python3.11/asyncio/runners.py:118: in run
    return self._loop.run_until_complete(task)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib64/python3.11/asyncio/base_events.py:654: in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ 

    async def _run() -> None:
        service = BridgeService(runtime_config, runtime_state)
    
        sent_frames: list[tuple[int, bytes]] = []
    
        async def fake_sender(command_id: int, payload: bytes) -> bool:
            sent_frames.append((command_id, payload))
            return True
    
        service.register_serial_sender(fake_sender)
    
        runtime_state.pending_digital_reads.append(
            PendingPinRequest(pin=7, reply_context=None)
        )
    
        await service.handle_mcu_frame(
            Command.CMD_DIGITAL_READ_RESP.value,
            bytes([1]),
        )
    
        queued = runtime_state.mqtt_publish_queue.get_nowait()
        expected_topic = topic_path(
            runtime_state.mqtt_topic_prefix,
            Topic.DIGITAL,
            "7",
            "value",
        )
        assert queued.topic_name == expected_topic
        assert queued.payload == b"1"
        runtime_state.mqtt_publish_queue.task_done()
    
>       assert sent_frames
E       assert []

openwrt-yun-bridge/tests/test_bridge_components_pin_system.py:74: AssertionError
------------------------------ Captured log call -------------------------------
WARNING  yunbridge.file:file.py:430 Unable to scan /tmp/systemd-private-ff21bf9e538242ab8e09185c42d2bc6d-systemd-resolved.service-WBTq09 for quota tracking: [Errno 13] Permission denied: '/tmp/systemd-private-ff21bf9e538242ab8e09185c42d2bc6d-systemd-resolved.service-WBTq09'
WARNING  yunbridge.file:file.py:430 Unable to scan /tmp/systemd-private-ff21bf9e538242ab8e09185c42d2bc6d-dbus-broker.service-RSTalB for quota tracking: [Errno 13] Permission denied: '/tmp/systemd-private-ff21bf9e538242ab8e09185c42d2bc6d-dbus-broker.service-RSTalB'
WARNING  yunbridge.file:file.py:430 Unable to scan /tmp/systemd-private-ff21bf9e538242ab8e09185c42d2bc6d-abrtd.service-DDI1SR for quota tracking: [Errno 13] Permission denied: '/tmp/systemd-private-ff21bf9e538242ab8e09185c42d2bc6d-abrtd.service-DDI1SR'
WARNING  yunbridge.file:file.py:430 Unable to scan /tmp/systemd-private-ff21bf9e538242ab8e09185c42d2bc6d-bluetooth.service-PirT6T for quota tracking: [Errno 13] Permission denied: '/tmp/systemd-private-ff21bf9e538242ab8e09185c42d2bc6d-bluetooth.service-PirT6T'
WARNING  yunbridge.file:file.py:430 Unable to scan /tmp/systemd-private-ff21bf9e538242ab8e09185c42d2bc6d-irqbalance.service-ZrAZVn for quota tracking: [Errno 13] Permission denied: '/tmp/systemd-private-ff21bf9e538242ab8e09185c42d2bc6d-irqbalance.service-ZrAZVn'
WARNING  yunbridge.file:file.py:430 Unable to scan /tmp/systemd-private-ff21bf9e538242ab8e09185c42d2bc6d-chronyd.service-oJloKo for quota tracking: [Errno 13] Permission denied: '/tmp/systemd-private-ff21bf9e538242ab8e09185c42d2bc6d-chronyd.service-oJloKo'
WARNING  yunbridge.file:file.py:430 Unable to scan /tmp/systemd-private-ff21bf9e538242ab8e09185c42d2bc6d-low-memory-monitor.service-aWMCku for quota tracking: [Errno 13] Permission denied: '/tmp/systemd-private-ff21bf9e538242ab8e09185c42d2bc6d-low-memory-monitor.service-aWMCku'
WARNING  yunbridge.file:file.py:430 Unable to scan /tmp/systemd-private-ff21bf9e538242ab8e09185c42d2bc6d-polkit.service-5bVYur for quota tracking: [Errno 13] Permission denied: '/tmp/systemd-private-ff21bf9e538242ab8e09185c42d2bc6d-polkit.service-5bVYur'
WARNING  yunbridge.file:file.py:430 Unable to scan /tmp/systemd-private-ff21bf9e538242ab8e09185c42d2bc6d-rtkit-daemon.service-FwD9EU for quota tracking: [Errno 13] Permission denied: '/tmp/systemd-private-ff21bf9e538242ab8e09185c42d2bc6d-rtkit-daemon.service-FwD9EU'
WARNING  yunbridge.file:file.py:430 Unable to scan /tmp/systemd-private-ff21bf9e538242ab8e09185c42d2bc6d-switcheroo-control.service-JKMNao for quota tracking: [Errno 13] Permission denied: '/tmp/systemd-private-ff21bf9e538242ab8e09185c42d2bc6d-switcheroo-control.service-JKMNao'
WARNING  yunbridge.file:file.py:430 Unable to scan /tmp/systemd-private-ff21bf9e538242ab8e09185c42d2bc6d-upower.service-d6G42b for quota tracking: [Errno 13] Permission denied: '/tmp/systemd-private-ff21bf9e538242ab8e09185c42d2bc6d-upower.service-d6G42b'
WARNING  yunbridge.file:file.py:430 Unable to scan /tmp/systemd-private-ff21bf9e538242ab8e09185c42d2bc6d-systemd-logind.service-oJRTOB for quota tracking: [Errno 13] Permission denied: '/tmp/systemd-private-ff21bf9e538242ab8e09185c42d2bc6d-systemd-logind.service-oJRTOB'
WARNING  yunbridge.file:file.py:430 Unable to scan /tmp/systemd-private-ff21bf9e538242ab8e09185c42d2bc6d-ModemManager.service-IZC6Hz for quota tracking: [Errno 13] Permission denied: '/tmp/systemd-private-ff21bf9e538242ab8e09185c42d2bc6d-ModemManager.service-IZC6Hz'
WARNING  yunbridge.file:file.py:430 Unable to scan /tmp/systemd-private-ff21bf9e538242ab8e09185c42d2bc6d-colord.service-TTSsjt for quota tracking: [Errno 13] Permission denied: '/tmp/systemd-private-ff21bf9e538242ab8e09185c42d2bc6d-colord.service-TTSsjt'
WARNING  yunbridge.file:file.py:430 Unable to scan /tmp/systemd-private-ff21bf9e538242ab8e09185c42d2bc6d-pcscd.service-xL3LUY for quota tracking: [Errno 13] Permission denied: '/tmp/systemd-private-ff21bf9e538242ab8e09185c42d2bc6d-pcscd.service-xL3LUY'
WARNING  yunbridge.file:file.py:430 Unable to scan /tmp/systemd-private-ff21bf9e538242ab8e09185c42d2bc6d-geoclue.service-GMGXhg for quota tracking: [Errno 13] Permission denied: '/tmp/systemd-private-ff21bf9e538242ab8e09185c42d2bc6d-geoclue.service-GMGXhg'
WARNING  yunbridge.file:file.py:430 Unable to scan /tmp/systemd-private-ff21bf9e538242ab8e09185c42d2bc6d-passim.service-fJ6ATd for quota tracking: [Errno 13] Permission denied: '/tmp/systemd-private-ff21bf9e538242ab8e09185c42d2bc6d-passim.service-fJ6ATd'
ERROR    yunbridge.service:runtime.py:265 Error handling MCU frame: CMD=0x15 payload=01
Traceback (most recent call last):
  File "/home/ignaciosantolin/arduino-yun-bridge2/openwrt-yun-bridge/yunbridge/services/runtime.py", line 263, in handle_mcu_frame
    await self._dispatcher.dispatch_mcu_frame(command_id, payload)
  File "/home/ignaciosantolin/arduino-yun-bridge2/openwrt-yun-bridge/yunbridge/services/dispatcher.py", line 191, in dispatch_mcu_frame
    await self.acknowledge_frame(command_id)
  File "/home/ignaciosantolin/arduino-yun-bridge2/openwrt-yun-bridge/yunbridge/services/runtime.py", line 397, in _acknowledge_mcu_frame
    payload = struct.pack(protocol.UINT16_FORMAT, command_id)
                          ^^^^^^^^
NameError: name 'protocol' is not defined
=========================== short test summary info ============================
FAILED openwrt-yun-bridge/tests/test_bridge_components_pin_system.py::test_mcu_digital_read_response_publishes_to_mqtt
!!!!!!!!!!!!!!!!!!!!!!!!!! stopping after 1 failures !!!!!!!!!!!!!!!!!!!!!!!!!!!
============================== 1 failed in 0.59s ===============================
py311: exit 1 (1.51 seconds) /home/ignaciosantolin/arduino-yun-bridge2> pytest --maxfail=1 pid=345804
  py311: FAIL code 1 (1.70=setup[0.19]+cmd[1.51] seconds)
  evaluation failed :( (1.88 seconds)
