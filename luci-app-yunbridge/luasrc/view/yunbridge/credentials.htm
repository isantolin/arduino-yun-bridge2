<%+header%>
<h2><%:Credentials & TLS%></h2>
<p><%:Manage shared secrets and TLS material without leaving LuCI.%></p>
<div class="cbi-section">
  <h3><%:Rotate Credentials%></h3>
  <p><%:This regenerates YUNBRIDGE_SERIAL_SECRET and the MQTT password, writes them to UCI, and restarts the daemon.%></p>
  <button class="cbi-button cbi-button-apply" onclick="rotateCredentials()"><%:Rotate now%></button>
  <pre id="rotate-output"></pre>
  <div id="arduino-snippet-section" style="display:none;">
    <h4><%:Arduino Secret Template%></h4>
    <p><%:Paste this snippet into your sketch (before including Bridge.h) so the MCU matches the new daemon secret.%></p>
    <button type="button" class="cbi-button" onclick="copySnippet()"><%:Copy snippet%></button>
    <pre id="arduino-snippet"></pre>
  </div>
</div>
<div class="cbi-section">
  <h3><%:TLS Material%></h3>
  <p><%:Upload new CA/certificate/key files via SCP or the provided helper:%></p>
  <pre>scp tls_bundle.tar.gz root@&lt;yun&gt;:/tmp/
ssh root@&lt;yun&gt; 'mkdir -p /etc/yunbridge/tls && tar -xzf /tmp/tls_bundle.tar.gz -C /etc/yunbridge/tls && chmod 600 /etc/yunbridge/tls/*'</pre>
  <p><%:Point the daemon to the new paths using the main configuration page.%></p>
</div>
<div class="cbi-section">
  <h3><%:Hardware Smoke Test%></h3>
  <p><%:Runs /usr/bin/yunbridge-hw-smoke to verify MQTT round trips and service health.%></p>
  <button class="cbi-button" onclick="runSmoke()"><%:Run smoke test%></button>
  <pre id="smoke-output"></pre>
</div>
<script type="text/javascript">
function rotateCredentials() {
  document.getElementById('rotate-output').textContent = '<%=translate("Running...")%>';
  fetch('<%=url("admin/services/yunbridge/rotate_credentials")%>', {method: 'POST'})
    .then(r => r.json())
    .then(data => {
      document.getElementById('rotate-output').textContent = data.output || data.message || JSON.stringify(data);
      const snippetSection = document.getElementById('arduino-snippet-section');
      const snippetEl = document.getElementById('arduino-snippet');
      if (data.sketch_snippet) {
        snippetEl.textContent = data.sketch_snippet;
        snippetSection.style.display = '';
      } else {
        snippetEl.textContent = '';
        snippetSection.style.display = 'none';
      }
    })
    .catch(err => {
      document.getElementById('rotate-output').textContent = err;
      document.getElementById('arduino-snippet-section').style.display = 'none';
      document.getElementById('arduino-snippet').textContent = '';
    });
}
function copySnippet() {
  const text = document.getElementById('arduino-snippet').textContent;
  if (!text) {
    return;
  }
  navigator.clipboard.writeText(text).catch(() => {
    /* ignore clipboard failures */
  });
}
function runSmoke() {
  document.getElementById('smoke-output').textContent = '<%=translate("Running...")%>';
  fetch('<%=url("admin/services/yunbridge/hw_smoke")%>', {method: 'POST'})
    .then(r => r.json())
    .then(data => {
      document.getElementById('smoke-output').textContent = data.output || data.message || JSON.stringify(data);
    })
    .catch(err => {
      document.getElementById('smoke-output').textContent = err;
    });
}
</script>
<%+footer%>
