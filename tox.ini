[tox]
envlist = py313, protocol, lint, flake8, typecheck, cppcheck
isolated_build = false
skip_missing_interpreters = true
skipsdist = true

[testenv]
basepython = python3.13
setenv =
    PYTHONPATH = {toxinidir}:{toxinidir}/openwrt-mcu-bridge:{toxinidir}/stubs
    PYTHONWARNINGS = default
passenv =
    LC_ALL
    LANG
deps =
    -r requirements/runtime.txt
    pytest
    pytest-asyncio
commands =
    pytest {posargs:openwrt-mcu-bridge/tests}

[testenv:lint]
description = Run static analysis via Ruff.
skip_install = true
deps =
    ruff==0.6.5
commands =
    ruff check {posargs:openwrt-mcu-bridge openwrt-mcu-examples-python tools openwrt-mcu-core/scripts}

[testenv:flake8]
description = Run Flake8 (pycodestyle + pyflakes + McCabe).
skip_install = true
deps =
    flake8
commands =
    flake8 {posargs:openwrt-mcu-bridge openwrt-mcu-examples-python tools openwrt-mcu-core/scripts}

[testenv:flake8-full]
description = Alias for flake8 (kept for convenience).
skip_install = true
deps =
    flake8
commands =
    flake8 {posargs:openwrt-mcu-bridge openwrt-mcu-examples-python tools openwrt-mcu-core/scripts}

[testenv:cppcheck]
description = Run static analysis for C++ code via Cppcheck.
skip_install = true
deps =
allowlist_externals = cppcheck
commands =
    cppcheck --enable=warning,performance,portability,style \
             --error-exitcode=1 \
             --suppress=missingIncludeSystem \
             --suppressions-list=tools/cppcheck_suppressions.txt \
             -I tools/arduino_stub/include \
             -I openwrt-library-arduino/src \
             openwrt-library-arduino/src/

[testenv:coverage]
basepython = python3.13
deps =
    {[testenv]deps}
    pytest-cov
    pytest-timeout
    gcovr
allowlist_externals =
    ./tools/coverage_python.sh
    ./tools/coverage_arduino.sh
commands =
    ./tools/coverage_python.sh
    ./tools/coverage_arduino.sh

[testenv:lua]
description = Run static analysis for Lua code.
deps =
    hererocks
allowlist_externals =
    .tox/lua_env/bin/luarocks
    .tox/lua_env/bin/luacheck
commands =
    hererocks .tox/lua_env -l5.1 -rlatest
    .tox/lua_env/bin/luarocks install luafilesystem
    .tox/lua_env/bin/luarocks install argparse
    .tox/lua_env/bin/luarocks install luacheck
    .tox/lua_env/bin/luacheck luci-app-mcubridge/luasrc

[testenv:protocol]
description = Ensure protocol bindings are regenerated.
skip_install = true
allowlist_externals = git
deps =
commands =
    python tools/protocol/generate.py --spec tools/protocol/spec.toml --py openwrt-mcu-bridge/mcubridge/protocol/protocol.py --cpp openwrt-library-arduino/src/protocol/rpc_protocol.h
    git diff --exit-code openwrt-mcu-bridge/mcubridge/protocol/protocol.py openwrt-library-arduino/src/protocol/rpc_protocol.h

[testenv:arduino]
description = Build + run host C++ tests for the Arduino library (via stubs).
skip_install = true
deps =
allowlist_externals =
    ./tools/ci_arduino_host_tests.sh
commands =
    ./tools/ci_arduino_host_tests.sh

[testenv:arduino-examples]
description = Compile Arduino examples to verify they build correctly.
skip_install = true
deps =
allowlist_externals =
    ./tools/ci_arduino.sh
commands =
    ./tools/ci_arduino.sh

[testenv:typecheck]
description = Run static type checking via Pyright.
skip_install = true
deps =
    pyright
    -r requirements/runtime.txt
commands =
    pyright
