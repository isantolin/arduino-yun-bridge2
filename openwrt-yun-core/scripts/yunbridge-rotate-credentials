#!/bin/sh
# Rotate YunBridge shared credentials in-place and restart the daemon.
# Usage: yunbridge-rotate-credentials [/etc/yunbridge/credentials]
set -eu

CRED_FILE=${1:-/etc/yunbridge/credentials}
CRED_DIR=$(dirname "$CRED_FILE")
TMP_FILE="${CRED_FILE}.tmp.$$"

if [ "$(id -u)" -ne 0 ]; then
    echo "[yunbridge-rotate-credentials] Run as root." >&2
    exit 1
fi

umask 077
mkdir -p "$CRED_DIR"

if [ -f "$CRED_FILE" ]; then
    # shellcheck disable=SC1090
    . "$CRED_FILE"
fi

random_hex() {
    head -c "$1" /dev/urandom | od -An -tx1 | tr -d ' \n'
}

random_b64() {
    head -c "$1" /dev/urandom | base64 | tr -d '\n='
}

YUNBRIDGE_SERIAL_SECRET=${YUNBRIDGE_SERIAL_SECRET:-""}
YUNBRIDGE_MQTT_USER=${YUNBRIDGE_MQTT_USER:-"yunbridge"}
YUNBRIDGE_MQTT_PASS=${YUNBRIDGE_MQTT_PASS:-""}
YUNBRIDGE_MQTT_CAFILE=${YUNBRIDGE_MQTT_CAFILE:-"/etc/yunbridge/tls/ca.crt"}
YUNBRIDGE_MQTT_CERTFILE=${YUNBRIDGE_MQTT_CERTFILE:-"/etc/yunbridge/tls/client.crt"}
YUNBRIDGE_MQTT_KEYFILE=${YUNBRIDGE_MQTT_KEYFILE:-"/etc/yunbridge/tls/client.key"}

YUNBRIDGE_SERIAL_SECRET="$(random_hex 32)"
YUNBRIDGE_MQTT_PASS="$(random_b64 32)"

cat >"$TMP_FILE" <<EOF
YUNBRIDGE_SERIAL_SECRET=$YUNBRIDGE_SERIAL_SECRET
YUNBRIDGE_MQTT_USER=$YUNBRIDGE_MQTT_USER
YUNBRIDGE_MQTT_PASS=$YUNBRIDGE_MQTT_PASS
YUNBRIDGE_MQTT_CAFILE=$YUNBRIDGE_MQTT_CAFILE
YUNBRIDGE_MQTT_CERTFILE=$YUNBRIDGE_MQTT_CERTFILE
YUNBRIDGE_MQTT_KEYFILE=$YUNBRIDGE_MQTT_KEYFILE
EOF

mv "$TMP_FILE" "$CRED_FILE"
chmod 600 "$CRED_FILE"

if command -v /etc/init.d/yunbridge >/dev/null 2>&1; then
    /etc/init.d/yunbridge restart >/dev/null 2>&1 || true
fi

echo "[yunbridge-rotate-credentials] Updated $CRED_FILE and restarted YunBridge." >&2
