#!/bin/sh
# Rotate McuBridge shared credentials stored in UCI and restart the daemon.
set -eu

if [ "$(id -u)" -ne 0 ]; then
    echo "[mcubridge-rotate-credentials] Run as root." >&2
    exit 1
fi

uci_get() {
    local key="$1"
    uci -q get "mcubridge.general.${key}" 2>/dev/null || true
}

random_hex() {
    local length="$1"
    if command -v python3 >/dev/null 2>&1; then
        python3 - "$length" <<'PY'
import binascii
import os
import sys

length = int(sys.argv[1])
print(binascii.hexlify(os.urandom(length)).decode(), end="")
PY
        return
    fi

    if command -v hexdump >/dev/null 2>&1; then
        head -c "$length" /dev/urandom | hexdump -v -e '/1 "%02x"'
        return
    fi

    if command -v od >/dev/null 2>&1; then
        head -c "$length" /dev/urandom | od -An -tx1 | tr -d ' \n'
        return
    fi

    echo "[mcubridge-rotate-credentials] ERROR: Need python3, hexdump, or od to generate random hex." >&2
    return 1
}

random_b64() {
    local length="$1"
    if command -v python3 >/dev/null 2>&1; then
        python3 - "$length" <<'PY'
import base64
import os
import sys

length = int(sys.argv[1])
print(base64.b64encode(os.urandom(length)).decode().rstrip('='), end="")
PY
        return
    fi

    if command -v base64 >/dev/null 2>&1; then
        head -c "$length" /dev/urandom | base64 | tr -d '\n='
        return
    fi

    # Absolute fallback: reuse hex output (still random ASCII, though longer)
    random_hex "$length"
}

SERIAL_SECRET="$(random_hex 32)"
if [ -z "$SERIAL_SECRET" ]; then
    echo "[mcubridge-rotate-credentials] ERROR: Failed to generate serial secret." >&2
    exit 1
fi

MQTT_PASS="$(random_b64 32)"
if [ -z "$MQTT_PASS" ]; then
    echo "[mcubridge-rotate-credentials] ERROR: Failed to generate MQTT password." >&2
    exit 1
fi

MQTT_USER=$(uci_get mqtt_user)
if [ -z "$MQTT_USER" ]; then
    MQTT_USER="mcubridge"
fi

uci set mcubridge.general.serial_shared_secret="$SERIAL_SECRET"
uci set mcubridge.general.mqtt_user="$MQTT_USER"
uci set mcubridge.general.mqtt_pass="$MQTT_PASS"
uci commit mcubridge

if command -v /etc/init.d/mcubridge >/dev/null 2>&1; then
    /etc/init.d/mcubridge restart >/dev/null 2>&1 || true
fi

printf 'SERIAL_SECRET=%s\n' "$SERIAL_SECRET"

echo "[mcubridge-rotate-credentials] Updated UCI credentials and restarted McuBridge." >&2
