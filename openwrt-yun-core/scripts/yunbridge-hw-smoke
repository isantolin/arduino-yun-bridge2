#!/bin/sh
# Run a basic YunBridge hardware smoke test locally on the device.
set -eu

if ! command -v mosquitto_pub >/dev/null 2>&1 || ! command -v mosquitto_sub >/dev/null 2>&1; then
    echo "[yunbridge-hw-smoke] mosquitto-client package is required." >&2
    exit 1
fi

STATUS_FILE="/tmp/yunbridge_status.json"
CRED_FILE="${YUNBRIDGE_CREDENTIALS_FILE:-/etc/yunbridge/credentials}"
MQTT_USER=""
MQTT_PASS=""
MQTT_CAFILE=""
MQTT_CERTFILE=""
MQTT_KEYFILE=""

if [ -f "$CRED_FILE" ]; then
    # shellcheck disable=SC1090
    . "$CRED_FILE"
    MQTT_USER=${YUNBRIDGE_MQTT_USER:-""}
    MQTT_PASS=${YUNBRIDGE_MQTT_PASS:-""}
    MQTT_CAFILE=${YUNBRIDGE_MQTT_CAFILE:-""}
    MQTT_CERTFILE=${YUNBRIDGE_MQTT_CERTFILE:-""}
    MQTT_KEYFILE=${YUNBRIDGE_MQTT_KEYFILE:-""}
fi

HOST=$(uci get yunbridge.general.mqtt_host 2>/dev/null || echo 127.0.0.1)
PORT=$(uci get yunbridge.general.mqtt_port 2>/dev/null || echo 8883)
TOPIC=$(uci get yunbridge.general.mqtt_topic 2>/dev/null || echo br)
TLS=$(uci get yunbridge.general.mqtt_tls 2>/dev/null || echo 1)

if ! /etc/init.d/yunbridge status >/dev/null 2>&1; then
    echo "[yunbridge-hw-smoke] YunBridge service is not running." >&2
    exit 1
fi

if [ ! -s "$STATUS_FILE" ]; then
    echo "[yunbridge-hw-smoke] Status file $STATUS_FILE missing or empty." >&2
    exit 1
fi

echo "[yunbridge-hw-smoke] Checking MQTT round trip via ${HOST}:${PORT}..." >&2
TMP_SUB="/tmp/yunbridge-smoke.$$"
trap 'rm -f "$TMP_SUB"' EXIT INT TERM

MOSQUITTO_SUB_ARGS="-h $HOST -p $PORT -t ${TOPIC}/system/status -C 1 -W 7"
MOSQUITTO_PUB_ARGS="-h $HOST -p $PORT -t ${TOPIC}/system/status/request -m {\"request\":\"ping\"}"

if [ "$TLS" = "1" ]; then
    if [ -n "$MQTT_CAFILE" ]; then
        MOSQUITTO_SUB_ARGS="$MOSQUITTO_SUB_ARGS --cafile $MQTT_CAFILE"
        MOSQUITTO_PUB_ARGS="$MOSQUITTO_PUB_ARGS --cafile $MQTT_CAFILE"
    fi
    if [ -n "$MQTT_CERTFILE" ] && [ -n "$MQTT_KEYFILE" ]; then
        MOSQUITTO_SUB_ARGS="$MOSQUITTO_SUB_ARGS --cert $MQTT_CERTFILE --key $MQTT_KEYFILE"
        MOSQUITTO_PUB_ARGS="$MOSQUITTO_PUB_ARGS --cert $MQTT_CERTFILE --key $MQTT_KEYFILE"
    fi
fi

if [ -n "$MQTT_USER" ]; then
    MOSQUITTO_SUB_ARGS="$MOSQUITTO_SUB_ARGS -u $MQTT_USER"
    MOSQUITTO_PUB_ARGS="$MOSQUITTO_PUB_ARGS -u $MQTT_USER"
fi
if [ -n "$MQTT_PASS" ]; then
    MOSQUITTO_SUB_ARGS="$MOSQUITTO_SUB_ARGS -P $MQTT_PASS"
    MOSQUITTO_PUB_ARGS="$MOSQUITTO_PUB_ARGS -P $MQTT_PASS"
fi

# shellcheck disable=SC2086
mosquitto_sub $MOSQUITTO_SUB_ARGS >"$TMP_SUB" &
SUB_PID=$!
sleep 1
# shellcheck disable=SC2086
mosquitto_pub $MOSQUITTO_PUB_ARGS >/dev/null

if ! wait "$SUB_PID" >/dev/null 2>&1; then
    echo "[yunbridge-hw-smoke] Did not receive response from daemon." >&2
    exit 1
fi

echo "[yunbridge-hw-smoke] Received response:"
cat "$TMP_SUB"

echo "[yunbridge-hw-smoke] Smoke test completed successfully." >&2
